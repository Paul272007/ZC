#!/bin/bash

# Args:
# $1 : compiler command
# $2 : output executable name
# $3 : remove executable after running (0 = yes, 1 = no, -1 = no executable was created (object file))

# Verify arguments number
if [ $# -ne 3 ]; then
    echo "Error: one argument expected. $# found."
    exit 1
fi

# *--- Variables ---* #
width=$(tput cols)
# Colours
RED='\e[31m'
YELLOW='\e[33m'
RESET='\e[0m'

output=$($1 -fdiagnostics-color=always 2>&1)
compilation_exit_code=$?

# Display warnings / errors
if [ "$compilation_exit_code" -ne 0 ]; then
    printf "${RED}%*s${RESET}\n" "$width" | tr ' ' '='
    echo "$output"
    printf "${RED}%*s${RESET}\n" "$width" | tr ' ' '='
    echo "Compilation error: the executable wasn't generated."
    exit 1
elif [[ "$output" == *"warning:"* ]]; then
    printf "${YELLOW}%*s${RESET}\n" "$width" | tr ' ' '='
    echo "$output"
    printf "${YELLOW}%*s${RESET}\n" "$width" | tr ' ' '='
fi

if [ "$3" -eq -1 ]; then
    # No executable was created (compilation only)
    exit 0
fi
# Execute the program: allow absolute paths, relative paths with directories,
# and plain filenames (run from current directory).
if [[ "$2" == /* ]] || [[ "$2" == *"/"* ]]; then
    # Path is absolute or contains a directory component -> run directly
    "${2}"
    echo # skip line in case the program output doesn't end with a newline
else
    # Plain filename -> run from current directory
    "./${2}"
    echo
fi

# Optionally remove the executable after running. Use rm safely with quoting.
if [ "$3" -eq 0 ]; then
    rm -f -- "$2"
fi